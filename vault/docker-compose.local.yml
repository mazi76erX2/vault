services:
  postgres:
    image: ankane/pgvector:latest
    container_name: vault-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: vault
    ports:
      - "54322:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d vault"]
      interval: 10s
      timeout: 5s
      retries: 10

  ollama:
    image: ollama/ollama:latest
    container_name: vault-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    environment:
      OLLAMA_HOST: 0.0.0.0:11434
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -fsS http://localhost:11434/api/tags > /dev/null || exit 1",
        ]
      interval: 15s
      timeout: 5s
      retries: 20

  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vault-backend
    depends_on:
      postgres:
        condition: service_healthy
      ollama:
        condition: service_healthy
    environment:
      # DB
      DATABASE_URL: postgresql+psycopg2://postgres:postgres@postgres:5432/vault

      # Ollama
      OLLAMA_HOST: http://ollama:11434
      OLLAMA_EMBED_MODEL: nomic-embed-text
      OLLAMA_CHAT_MODEL: llama3.2
      EMBEDDING_DIM: "768"

      # App
      LOG_LEVEL: INFO
      KB_TOP_K: "5"
      KB_CHUNK_SIZE: "1200"
      KB_CHUNK_OVERLAP: "150"

      # Supabase local (optional)
      SUPABASE_URL: ""
      SUPABASE_KEY: ""
      SUPABASE_SERVICE_KEY: ""

      # JWT verification secret (must match local GoTrue GOTRUE_JWT_SECRET)
      SUPABASE_JWT_SECRET: ""
      SUPABASE_JWT_AUDIENCE: "authenticated"
    ports:
      - "7860:7860"
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs
    restart: unless-stopped

volumes:
  postgres-data:
  ollama-data:
