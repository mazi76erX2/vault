---
# Database Migration Job
apiVersion: batch/v1
kind: Job
metadata:
  name: vault-db-migration
  namespace: hico-vault
spec:
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
      # Wait for PostgreSQL to be ready
      - name: wait-for-postgres
        image: postgres:15
        command: ['sh', '-c']
        args:
        - |
          echo "Waiting for PostgreSQL to be ready..."
          until pg_isready -h postgres-service -p 5432 -U postgres; do
            echo "PostgreSQL is unavailable - sleeping"
            sleep 2
          done
          echo "PostgreSQL is ready!"
        env:
        - name: PGPASSWORD
          value: postgres
      containers:
      - name: migration
        image: postgres:15
        command: ['sh', '-c']
        args:
        - |
          echo "ðŸš€ Starting HICO Vault Database Migrations..."
          
          # Run migrations in order
          echo "ðŸ“¦ Running database migrations..."
          
          # Initial schema migration
          echo "Running initial schema..."
          psql -h postgres-service -p 5432 -U postgres -d postgres -v ON_ERROR_STOP=1 << 'EOF'
          -- Enable necessary extensions
          CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
          
          -- Create custom enums
          DO $$ BEGIN
              CREATE TYPE public.securitylevel AS ENUM('Public','Low','High', 'Critical', 'Medium');
          EXCEPTION
              WHEN duplicate_object THEN null;
          END $$;
          
          DO $$ BEGIN
              CREATE TYPE public.statusenum AS ENUM('Draft','Pending','On Review', 'Rejected', 'Validated - Stored', 'Validated - Awaiting Approval');
          EXCEPTION
              WHEN duplicate_object THEN null;
          END $$;
          
          DO $$ BEGIN
              CREATE TYPE public.sessionstatusenum AS ENUM('Not Started','Started','Completed', 'In Progress');
          EXCEPTION
              WHEN duplicate_object THEN null;
          END $$;
          
          DO $$ BEGIN
              CREATE TYPE public.document_status AS ENUM('pending','in_progress','completed');
          EXCEPTION
              WHEN duplicate_object THEN null;
          END $$;
          
          DO $$ BEGIN
              CREATE TYPE public.user_access_levels AS ENUM('admin','manager','employee', 'guest');
          EXCEPTION
              WHEN duplicate_object THEN null;
          END $$;
          
          DO $$ BEGIN
              CREATE TYPE public.department AS ENUM('AI CC','Planning','Analytics', 'HR', 'Data & Cloud', 'Sales', 'Marketing');
          EXCEPTION
              WHEN duplicate_object THEN null;
          END $$;
          
          DO $$ BEGIN
              CREATE TYPE public.ldap_connector_status AS ENUM ('inactive', 'active', 'syncing', 'failed', 'complete');
          EXCEPTION
              WHEN duplicate_object THEN null;
          END $$;
          
          -- Create companies table (core table for multi-tenancy)
          CREATE TABLE IF NOT EXISTS public.companies (
            id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
            created_at timestamp with time zone NOT NULL DEFAULT now(),
            name text NOT NULL,
            registered_since date NOT NULL,
            user_chat_bubble_colour text NULL DEFAULT '#007bff',
            bot_chat_bubble_colour text NULL DEFAULT '#e5e5ea',
            send_button_and_box text NULL DEFAULT '#ffffff',
            font text NULL DEFAULT 'Tahoma',
            logo text NULL,
            bot_profile_picture text NULL,
            user_chat_font_colour text NULL DEFAULT '#000000',
            bot_chat_font_colour text NULL DEFAULT '#000000',
            contact_user_id uuid NULL,
            contact_first_name text NULL,
            contact_last_name text NULL,
            contact_email text NULL,
            contact_telephone text NULL,
            company_reg_no text NOT NULL UNIQUE,
            CONSTRAINT company_pkey PRIMARY KEY (id)
          );
          
          -- Create basic tables for the application
          CREATE TABLE IF NOT EXISTS public.user_types (
            id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
            name text NOT NULL,
            description text NULL,
            created_at timestamp with time zone NOT NULL DEFAULT now(),
            CONSTRAINT user_types_pkey PRIMARY KEY (id),
            CONSTRAINT user_types_name_key UNIQUE (name)
          );
          
          CREATE TABLE IF NOT EXISTS public.roles (
            id uuid NOT NULL DEFAULT uuid_generate_v4(),
            name text NOT NULL,
            description text NULL,
            created_at timestamp with time zone NULL DEFAULT now(),
            CONSTRAINT roles_pkey PRIMARY KEY (id),
            CONSTRAINT roles_name_key UNIQUE (name)
          );
          
          CREATE TABLE IF NOT EXISTS public.ldap_connectors (
            id uuid NOT NULL DEFAULT uuid_generate_v4(),
            name text NOT NULL,
            server_url text NOT NULL,
            bind_dn text NOT NULL,
            bind_password text NOT NULL,
            search_base text NOT NULL,
            search_filter text NULL DEFAULT '(objectClass=person)',
            user_attributes jsonb NULL DEFAULT '{"username": "sAMAccountName", "email": "mail", "full_name": "displayName", "department": "department"}',
            ssl_enabled boolean NOT NULL DEFAULT false,
            port integer NOT NULL DEFAULT 389,
            timeout integer NOT NULL DEFAULT 30,
            page_size integer NOT NULL DEFAULT 1000,
            status public.ldap_connector_status NOT NULL DEFAULT 'inactive',
            last_sync timestamp with time zone NULL,
            sync_count integer NOT NULL DEFAULT 0,
            error_message text NULL,
            created_at timestamp with time zone NOT NULL DEFAULT now(),
            updated_at timestamp with time zone NOT NULL DEFAULT now(),
            created_by uuid NULL,
            company_id bigint NOT NULL,
            domain text,
            base_dn text,
            user_dn text,
            group_dn text,
            user_object text DEFAULT 'user',
            group_object text DEFAULT 'group',
            CONSTRAINT ldap_connectors_pkey PRIMARY KEY (id),
            CONSTRAINT ldap_connectors_name_key UNIQUE (name),
            CONSTRAINT ldap_connectors_company_id_fkey FOREIGN KEY (company_id) REFERENCES companies (id) ON DELETE CASCADE
          );
          
          -- Insert seed data
          INSERT INTO public.companies (id, name, company_reg_no, contact_email, registered_since, created_at)
          VALUES 
              (1, 'HICO Group', 'A001', 'admin@hico-group.com', '2024-01-01', NOW())
          ON CONFLICT (company_reg_no) DO UPDATE SET
              name = EXCLUDED.name,
              contact_email = EXCLUDED.contact_email;
          
          INSERT INTO public.user_types (id, name, description)
          VALUES 
              (1, 'Administrator', 'System administrator with full access'),
              (2, 'Manager', 'Department manager with elevated privileges'),
              (3, 'Employee', 'Regular employee with standard access'),
              (4, 'Guest', 'Limited access guest user')
          ON CONFLICT (name) DO NOTHING;
          
          INSERT INTO public.roles (id, name, description)
          VALUES 
              ('b86db406-e7b5-4cc0-ad2c-39cf0557f367', 'Administrator', 'Full system administrator'),
              ('c97eb507-f8c6-5dd1-be3d-40df0668f468', 'Manager', 'Department manager'),
              ('d08fc608-09d7-6ee2-cf4e-51e0779f569', 'Employee', 'Standard employee'),
              ('e19fd709-1ae8-7ff3-d05f-62f1880f670a', 'Guest', 'Guest user with limited access')
          ON CONFLICT (name) DO NOTHING;
          
          EOF
          
          echo "âœ… Database migration completed successfully!"
          echo "Database is ready for HICO Vault!"
        env:
        - name: PGPASSWORD
          value: postgres 