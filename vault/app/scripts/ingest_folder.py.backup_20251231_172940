import argparse
from pathlib import Path
from typing import List

from app.core.config import settings
from app.database import SessionLocal, init_db
from app.integrations.ollama_client import embed
from app.models.kb import KBChunk
from app.services.rag_service import chunk_text
from sqlalchemy.orm import Session


def read_txt(path: Path) -> str:
    return path.read_text(encoding="utf-8", errors="ignore")


def read_pdf(path: Path) -> str:
    from PyPDF2 import PdfReader

    reader = PdfReader(str(path))
    parts = []
    for page in reader.pages:
        parts.append(page.extract_text() or "")
    return "\n".join(parts)


def read_docx(path: Path) -> str:
    import docx

    d = docx.Document(str(path))
    return "\n".join(p.text for p in d.paragraphs)


def extract_text(path: Path) -> str:
    ext = path.suffix.lower()
    if ext == ".txt":
        return read_txt(path)
    if ext == ".pdf":
        return read_pdf(path)
    if ext == ".docx":
        return read_docx(path)
    return ""


def upsert_doc(
    db: Session, doc_id: str, title: str, sourcefile: str, chunks: List[str]
) -> None:
    db.query(KBChunk).filter(KBChunk.doc_id == doc_id).delete()

    rows: List[KBChunk] = []
    for i, ch in enumerate(chunks, start=1):
        rows.append(
            KBChunk(
                doc_id=doc_id,
                chunk_index=i,
                title=title,
                sourcefile=sourcefile,
                content=ch,
                accesslevel=1,
                embedding=embed(ch),
            )
        )

    db.add_all(rows)
    db.commit()


def main() -> None:
    parser = argparse.ArgumentParser()
    parser.add_argument(
        "--folder", required=True, help="Folder with .txt/.pdf/.docx files"
    )
    parser.add_argument("--chunk-size", type=int, default=settings.kb_chunk_size)
    parser.add_argument("--chunk-overlap", type=int, default=settings.kb_chunk_overlap)
    args = parser.parse_args()

    init_db()

    folder = Path(args.folder)
    if not folder.exists():
        raise SystemExit(f"Folder not found: {folder}")

    db = SessionLocal()
    try:
        for path in folder.rglob("*"):
            if not path.is_file():
                continue
            if path.suffix.lower() not in {".txt", ".pdf", ".docx"}:
                continue

            text = extract_text(path).strip()
            if not text:
                continue

            chunks = chunk_text(
                text, chunk_size=args.chunk_size, overlap=args.chunk_overlap
            )
            if not chunks:
                continue

            doc_id = str(path.resolve())
            title = path.name
            sourcefile = str(path)

            upsert_doc(
                db, doc_id=doc_id, title=title, sourcefile=sourcefile, chunks=chunks
            )
            print(f"Ingested {path} ({len(chunks)} chunks)")

    finally:
        db.close()


if __name__ == "__main__":
    main()
